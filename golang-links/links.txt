https://eli.thegreenplace.net/2009/08/29/co-routines-as-an-alternative-to-state-machines